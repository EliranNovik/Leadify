# Webhook Control Feature

## Overview

This feature allows administrators to enable/disable the webhook endpoint (`/api/hook/catch`) that receives new lead data. This is useful for:

- Temporarily stopping new leads from being created
- Performing maintenance or data migration
- Managing system load during peak times

## Setup Instructions

### 1. Create the Database Table

Run the SQL migration file to create the `webhook_settings` table:

```bash
# Using Supabase CLI
supabase db push supabase_migrations/webhook_settings_table.sql

# Or directly in Supabase SQL Editor
# Copy and paste the contents of supabase_migrations/webhook_settings_table.sql
```

### 2. Verify Table Creation

Check that the table was created successfully:

```sql
SELECT * FROM webhook_settings;
```

You should see a default record with `is_active = true`.

### 3. Access the Settings UI

1. Log in as a superuser or admin
2. Navigate to **Admin Panel** (sidebar)
3. Go to **Hooks** → **Settings**
4. You'll see the Webhook Settings page with a toggle switch

## How It Works

### Frontend Component

- **Location**: `src/components/admin/WebhookSettingsManager.tsx`
- **Features**:
  - Toggle switch to enable/disable webhook
  - Visual status indicators (green for active, red for inactive)
  - Last updated timestamp
  - Updated by user tracking
  - Important information and warnings

### Backend Integration

- **Location**: `backend/src/controllers/webhookController.js`
- **Function**: `isWebhookEnabled()`
- **Behavior**:
  - Checks `webhook_settings` table before processing any webhook request
  - Returns `503 Service Unavailable` if webhook is disabled
  - Logs all enable/disable actions
  - Safe default: If table doesn't exist or error occurs, webhook remains enabled

### Affected Endpoints

When webhook is disabled, the following endpoints will reject requests:

- `POST /api/hook/catch` - Regular webhook for form submissions
- `POST /api/hook/facebook` - Facebook Lead Ads webhook

### Response When Disabled

```json
{
  "success": false,
  "error": "Webhook endpoint is currently disabled",
  "message": "The webhook is temporarily unavailable. Please try again later or contact support."
}
```

## Database Schema

```sql
CREATE TABLE webhook_settings (
  id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
  is_active BOOLEAN NOT NULL DEFAULT true,
  last_updated TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
  updated_by TEXT,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);
```

### Row Level Security (RLS)

- Only admins and superusers can read webhook settings
- Only admins and superusers can insert/update webhook settings
- Regular users cannot access this table

## Usage

### Enable Webhook

1. Go to Admin Panel → Hooks → Settings
2. Click the toggle switch to enable (green)
3. The system will immediately start accepting new leads

### Disable Webhook

1. Go to Admin Panel → Hooks → Settings
2. Click the toggle switch to disable (red)
3. The system will immediately reject all incoming webhook requests

### Monitor Status

- Check the status indicator on the settings page
- View "Last Updated" timestamp to see when status last changed
- See who made the last change in "Updated By" field

## Testing

### Test Webhook Status

```bash
# Test when enabled (should create lead)
curl -X POST https://your-backend.com/api/hook/catch \
  -H "Content-Type: application/json" \
  -d '{"name":"Test User","email":"test@example.com","phone":"1234567890"}'

# Test when disabled (should return 503)
# Expected response: {"success":false,"error":"Webhook endpoint is currently disabled",...}
```

### Verify in Database

```sql
-- Check current webhook status
SELECT is_active, last_updated, updated_by
FROM webhook_settings
ORDER BY created_at DESC
LIMIT 1;

-- Check access logs (if enabled)
SELECT * FROM access_logs
WHERE endpoint LIKE '%/api/hook/%'
ORDER BY created_at DESC
LIMIT 10;
```

## Troubleshooting

### Webhook Settings Not Loading

1. Check that the `webhook_settings` table exists
2. Verify RLS policies are set correctly
3. Check browser console for errors
4. Verify user has admin or superuser permissions

### Changes Not Taking Effect

1. Refresh the backend server (if running locally)
2. Check backend logs for errors
3. Verify database connection is working
4. Test with a simple curl request to the webhook endpoint

### Backend Errors

If you see errors like "table webhook_settings does not exist":

1. Run the migration SQL file
2. Create the table manually using the schema above
3. Insert a default record: `INSERT INTO webhook_settings (is_active) VALUES (true);`

## Security Notes

- Only admins and superusers can access webhook settings
- All changes are logged with timestamp and user
- The webhook defaults to ENABLED if settings table doesn't exist (fail-safe)
- Disabling the webhook affects ALL webhook sources (regular forms and Facebook)

## Future Enhancements

Possible improvements:

- Per-source webhook controls (enable/disable only Facebook, only forms, etc.)
- Scheduled enable/disable times
- Webhook rate limiting settings
- Email notifications when webhook status changes
- Webhook activity dashboard with statistics
